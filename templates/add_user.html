{% extends "base.html" %}

{% block title %}Add New User - LFMS{% endblock %}

{% block content %}
<div class="container">
  <div class="card">
    <div class="card-header">
      <h4 class="mb-0">Add New User</h4>
    </div>
    <div class="card-body p-4">
      <form method="POST" action="{{ url_for('add_user') }}" class="needs-validation" novalidate>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="name" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="name" name="name" required />
            <div class="invalid-feedback">Please enter a name.</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="email" name="email" required />
            <div class="invalid-feedback">Please enter a valid email.</div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="designation" class="form-label">Designation</label>
            <select class="form-select" id="designation" name="designation" required>
              <option value="">Select Designation</option>
              <option value="Executive">Executive</option>
              <option value="Sr. Executive">Sr. Executive</option>
              <option value="Assistant Manager">Assistant Manager</option>
              <option value="Deputy Manager">Deputy Manager</option>
              <option value="Manager">Manager</option>
              <option value="Senior Manager">Senior Manager</option>
              <option value="Assistant General Manager">Assistant General Manager</option>
              <option value="Deputy General Manager">Deputy General Manager</option>
              <option value="Executive Director">Executive Director</option>
              <option value="Director">Director</option>
              <option value="CFO">CFO</option>
              <option value="CEO">CEO</option>
            </select>
            <div class="invalid-feedback">Please select a designation.</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="department" class="form-label">Department</label>
            <select class="form-select" id="department" name="department" required>
              <option value="" disabled selected>Select Department</option>
              <option>Finance</option>
              <option>Health & Safety</option>
              <option>HR & Admin</option>
              <option>IT</option>
              <option>Logistics & Operation</option>
              <option>Legal & Compliance</option>
              <option>Procurement</option>
              <option>Sales & Marketing</option>
              <option>Plant Operations</option>
              <option>Others</option>
            </select>
            <div class="invalid-feedback">Please select a department.</div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="supervisor_name" class="form-label">Supervisor Name</label>
            <select class="form-select" id="supervisor_name" name="supervisor_name" onchange="setSupervisorEmail(this)" required>
              <option value="">Select Supervisor</option>
              {% for supervisor in supervisors %}
                <option value="{{ supervisor.name }}" data-email="{{ supervisor.email }}">{{ supervisor.name }}</option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">Please select a supervisor.</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="supervisor_email" class="form-label">Supervisor Email</label>
            <input type="email" class="form-control" id="supervisor_email" name="supervisor_email" readonly required />
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="company" class="form-label">Company</label>
            <select class="form-select" id="company" name="company" required>
              <option value="" disabled selected>Select Company</option>
              <option>Petromax LPG LTD.</option>
              <option>Petromax Cylinder LTD.</option>
            </select>
            <div class="invalid-feedback">Please select a company.</div>
          </div>
          <div class="col-md-6 mb-3">
            <label for="location" class="form-label">Location</label>
            <select class="form-select" id="location" name="location" required>
              <option value="" disabled selected>Select Location</option>
              <option>Head Office</option>
              <option>Rupganj Plant</option>
              <option>Mongla Plant</option>
              <option>Tangail Plant</option>
              <option>DD & RDC</option>
            </select>
            <div class="invalid-feedback">Please select a location.</div>
          </div>
        </div>

        <hr>
        <h5>Permissions</h5>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label for="role" class="form-label">Role</label>
            <select id="role" name="role" class="form-select" required>
              <option value="user" selected>User</option>
              <option value="supervisor">Supervisor</option>
              <option value="ceo">CEO</option>
              <option value="legal_team">Legal Team</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label for="view_access" class="form-label">View Access</label>
            <select id="view_access" name="view_access" class="form-select">
              <option value="No" selected>No</option>
              <option value="Yes">Yes</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label for="is_approved" class="form-label">Approval Status</label>
            <select id="is_approved" name="is_approved" class="form-select">
              <option value="1" selected>Approved</option>
              <option value="0">Not Approved</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">Create User</button>
          <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Bootstrap 5 form validation
  (() => {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  })();

  // Supervisor Email Setter
  function setSupervisorEmail(select) {
    const selectedOption = select.options[select.selectedIndex];
    const email = selectedOption ? selectedOption.getAttribute('data-email') : '';
    document.getElementById('supervisor_email').value = email || '';
  }
</script>
{% endblock %}